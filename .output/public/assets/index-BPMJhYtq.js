var d=Object.defineProperty;var p=(n,e,t)=>e in n?d(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var i=(n,e,t)=>p(n,typeof e!="symbol"?e+"":e,t);typeof registration<"u"&&registration.scope;class c{constructor(){i(this,"promise");i(this,"resolve");i(this,"reject");this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}const _=(n,e)=>new Promise(t=>{const s=new MessageChannel;s.port1.onmessage=r=>{t(r.data)},n.postMessage(e,[s.port2])});class a{constructor(e,t){i(this,"type");i(this,"target");i(this,"sw");i(this,"originalEvent");i(this,"isExternal");this.type=e,Object.assign(this,t)}}class w{constructor(){i(this,"_eventListenerRegistry",new Map)}addEventListener(e,t){this._getEventListenersByType(e).add(t)}removeEventListener(e,t){this._getEventListenersByType(e).delete(t)}dispatchEvent(e){e.target=this;const t=this._getEventListenersByType(e.type);for(const s of t)s(e)}_getEventListenersByType(e){return this._eventListenerRegistry.has(e)||this._eventListenerRegistry.set(e,new Set),this._eventListenerRegistry.get(e)}}function l(n,e){const{href:t}=location;return new URL(n,t).href===new URL(e,t).href}const v=200,f=6e4,u={type:"SKIP_WAITING"};class m extends w{constructor(t,s={}){super();i(this,"_scriptURL");i(this,"_registerOptions",{});i(this,"_updateFoundCount",0);i(this,"_swDeferred",new c);i(this,"_activeDeferred",new c);i(this,"_controllingDeferred",new c);i(this,"_registrationTime",0);i(this,"_isUpdate");i(this,"_compatibleControllingSW");i(this,"_registration");i(this,"_sw");i(this,"_ownSWs",new Set);i(this,"_externalSW");i(this,"_waitingTimeout");i(this,"_onUpdateFound",t=>{const s=this._registration,r=s.installing,o=this._updateFoundCount>0||!l(r.scriptURL,this._scriptURL.toString())||performance.now()>this._registrationTime+f;o?(this._externalSW=r,s.removeEventListener("updatefound",this._onUpdateFound)):(this._sw=r,this._ownSWs.add(r),this._swDeferred.resolve(r)),this.dispatchEvent(new a("installing",{sw:r,originalEvent:t,isExternal:o,isUpdate:this._isUpdate})),++this._updateFoundCount,r.addEventListener("statechange",this._onStateChange)});i(this,"_onStateChange",t=>{const s=this._registration,r=t.target,{state:o}=r,h=r===this._externalSW,g={sw:r,isExternal:h,originalEvent:t};!h&&this._isUpdate&&(g.isUpdate=!0),this.dispatchEvent(new a(o,g)),o==="installed"?this._waitingTimeout=self.setTimeout(()=>{o==="installed"&&s.waiting===r&&this.dispatchEvent(new a("waiting",g))},v):o==="activating"&&(clearTimeout(this._waitingTimeout),h||this._activeDeferred.resolve(r))});i(this,"_onControllerChange",t=>{const s=this._sw,r=s!==navigator.serviceWorker.controller;this.dispatchEvent(new a("controlling",{isExternal:r,originalEvent:t,sw:s,isUpdate:this._isUpdate})),r||this._controllingDeferred.resolve(s)});i(this,"_onMessage",async t=>{const{data:s,ports:r,source:o}=t;await this.getSW(),this._ownSWs.has(o)&&this.dispatchEvent(new a("message",{data:s,originalEvent:t,ports:r,sw:o}))});this._scriptURL=t,this._registerOptions=s,navigator.serviceWorker.addEventListener("message",this._onMessage)}async register({immediate:t=!1}={}){!t&&document.readyState!=="complete"&&await new Promise(r=>window.addEventListener("load",r)),this._isUpdate=!!navigator.serviceWorker.controller,this._compatibleControllingSW=this._getControllingSWIfCompatible(),this._registration=await this._registerScript(),this._compatibleControllingSW&&(this._sw=this._compatibleControllingSW,this._activeDeferred.resolve(this._compatibleControllingSW),this._controllingDeferred.resolve(this._compatibleControllingSW),this._compatibleControllingSW.addEventListener("statechange",this._onStateChange,{once:!0}));const s=this._registration.waiting;return s&&l(s.scriptURL,this._scriptURL.toString())&&(this._sw=s,Promise.resolve().then(()=>{this.dispatchEvent(new a("waiting",{sw:s,wasWaitingBeforeRegister:!0}))})),this._sw&&(this._swDeferred.resolve(this._sw),this._ownSWs.add(this._sw)),this._registration.addEventListener("updatefound",this._onUpdateFound),navigator.serviceWorker.addEventListener("controllerchange",this._onControllerChange),this._registration}async update(){this._registration&&await this._registration.update()}get active(){return this._activeDeferred.promise}get controlling(){return this._controllingDeferred.promise}getSW(){return this._sw!==void 0?Promise.resolve(this._sw):this._swDeferred.promise}async messageSW(t){const s=await this.getSW();return _(s,t)}messageSkipWaiting(){var t;(t=this._registration)!=null&&t.waiting&&_(this._registration.waiting,u)}_getControllingSWIfCompatible(){const t=navigator.serviceWorker.controller;if(t&&l(t.scriptURL,this._scriptURL.toString()))return t}async _registerScript(){try{const t=await navigator.serviceWorker.register(this._scriptURL,this._registerOptions);return this._registrationTime=performance.now(),t}catch(t){throw t}}}export{m as Serwist,a as SerwistEvent,_ as messageSW};
